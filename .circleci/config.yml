version: 2.1

orbs:
  node: circleci/node@4.5.1

executors:
  default_executor:
    working_directory: ~/jsonapi-transformers
    docker:
      - image: cimg/node:12.22.3
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD

jobs:
  build_and_test:
    executor: default_executor
    steps:
      - checkout
      - node/install-packages
      - run:
          name: Define environment variable with lastest commit's message
          command: |
            echo 'export COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Lint commit message
          command: echo "$COMMIT_MESSAGE" | npx commitlint
      - run:
          name: Run linters
          command: npm run lint
      - run:
          name: Run unit tests
          command: npm run test
      - run:
          name: Rebuild the release directory (lib/)
          command: npm run build
      - run:
          name: Semantic Release
          command: npx semantic-release

workflows:
  test:
    jobs:
      - build_and_test
